/******************************************************************************************
   SQL SERVER WORKLOAD TYPE DIAGNOSTIC SCRIPT
   Purpose : Helps determine if your workload behaves like OLTP, Mixed, or OLAP
   Author  : ChatGPT
   Safe to run: âœ… (Read-only)
******************************************************************************************/

/******************************************************************************************
 STEP 1 â€” ANALYZE QUERY PATTERNS
******************************************************************************************/
PRINT 'STEP 1 â€” Query Duration and Execution Patterns';

SELECT 
    DB_NAME(st.dbid) AS DatabaseName,
    COUNT(*) AS QueryCount,
    AVG(total_elapsed_time / execution_count) / 1000 AS AvgElapsedMs,
    AVG(total_worker_time / execution_count) / 1000 AS AvgCPUms,
    AVG(total_logical_reads / execution_count) AS AvgLogicalReads,
    SUM(execution_count) AS TotalExecutions
FROM sys.dm_exec_query_stats AS qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS st
WHERE st.dbid IS NOT NULL
GROUP BY DB_NAME(st.dbid)
ORDER BY AvgElapsedMs DESC;

/*
INTERPRETATION:
 ðŸŸ¢ OLTP: High TotalExecutions, low AvgElapsedMs (<50â€“100ms)
 ðŸŸ¡ Mixed: Mix of frequent short and some long-running queries
 ðŸ”µ OLAP: Few queries with very high AvgElapsedMs (>500ms)
*/


/******************************************************************************************
 STEP 2 â€” CHECK TOP WAIT TYPES
******************************************************************************************/
PRINT 'STEP 2 â€” Wait Type Analysis';

SELECT TOP 10 
    wait_type, 
    wait_time_ms/1000.0 AS WaitTimeSec,
    waiting_tasks_count,
    wait_time_ms/NULLIF(waiting_tasks_count,0) AS AvgWaitMs
FROM sys.dm_os_wait_stats
WHERE wait_type NOT IN (
    'SLEEP_TASK','BROKER_TASK_STOP','SQLTRACE_BUFFER_FLUSH',
    'XE_TIMER_EVENT','XE_DISPATCHER_WAIT'
)
ORDER BY wait_time_ms DESC;

/*
INTERPRETATION:
 - PAGEIOLATCH_* â†’ Many small reads (OLTP)
 - CXPACKET/CXCONSUMER â†’ Parallel queries (Mixed/OLAP)
 - LCK_* â†’ High lock contention (OLTP)
 - ASYNC_NETWORK_IO â†’ Large result sets (OLAP)
*/


/******************************************************************************************
 STEP 3 â€” LOOK AT QUERY EXECUTION COUNTS VS DURATION
******************************************************************************************/
PRINT 'STEP 3 â€” Top Queries by Average Duration';

SELECT TOP 20
    DB_NAME(st.dbid) AS DatabaseName,
    SUBSTRING(st.text, 1, 100) AS SampleQueryText,
    qs.execution_count,
    (qs.total_elapsed_time / qs.execution_count) / 1000 AS AvgElapsedMs,
    (qs.total_logical_reads / qs.execution_count) AS AvgReads
FROM sys.dm_exec_query_stats qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) st
WHERE st.dbid IS NOT NULL
ORDER BY AvgElapsedMs DESC;

/*
INTERPRETATION:
 - OLTP: High execution_count, low AvgElapsedMs
 - Mixed: Variety of both short and long queries
 - OLAP: Few queries, very high AvgElapsedMs and AvgReads
*/


/******************************************************************************************
 STEP 4 â€” AVERAGE READS PER QUERY
******************************************************************************************/
PRINT 'STEP 4 â€” Average Reads per Query';

SELECT 
    AVG(total_logical_reads / execution_count) AS AvgReadsPerExec,
    AVG(total_physical_reads / execution_count) AS AvgPhysicalReadsPerExec
FROM sys.dm_exec_query_stats;

/*
INTERPRETATION:
 - <100 reads  â†’ OLTP (index seeks)
 - 100â€“10,000 â†’ Mixed workload
 - >10,000    â†’ OLAP (scans, aggregates, joins)
*/


/******************************************************************************************
 STEP 5 â€” TRANSACTION VS CPU RATIO (I/O vs. CPU)
******************************************************************************************/
PRINT 'STEP 5 â€” I/O vs. CPU Ratio';

SELECT 
    SUM(num_of_writes) AS TotalWrites,
    SUM(num_of_reads) AS TotalReads,
    SUM(io_stall_read_ms) AS ReadStallMs,
    SUM(io_stall_write_ms) AS WriteStallMs
FROM sys.dm_io_virtual_file_stats(NULL, NULL);

SELECT 
    total_cpu_usage_ms = SUM(total_worker_time)/1000
FROM sys.dm_exec_query_stats;

/*
INTERPRETATION:
 - CPU much greater than I/O â†’ OLAP or Mixed (analytical)
 - I/O much greater than CPU â†’ OLTP (many small transactions)
*/


/******************************************************************************************
 STEP 6 â€” PARALLELISM (Degree of Parallelism per Query)
******************************************************************************************/
PRINT 'STEP 6 â€” Query Parallelism Overview';

SELECT TOP 20 
    DB_NAME(st.dbid) AS DatabaseName,
    qs.execution_count,
    qs.max_dop AS DegreeOfParallelism,
    (qs.total_elapsed_time / qs.execution_count) / 1000 AS AvgElapsedMs,
    SUBSTRING(st.text, 1, 120) AS QueryText
FROM sys.dm_exec_query_stats qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) st
WHERE qs.max_dop > 1
ORDER BY AvgElapsedMs DESC;

/*
INTERPRETATION:
 - Most queries with MAXDOP = 1 â†’ OLTP
 - Mix of MAXDOP > 1 and 1 â†’ Mixed
 - Majority parallel (MAXDOP > 1) â†’ OLAP
*/


/******************************************************************************************
 STEP 7 â€” QUICK SUMMARY METRIC (ONE-LINER SNAPSHOT)
******************************************************************************************/
PRINT 'STEP 7 â€” Summary Snapshot';

SELECT 
    COUNT(*) AS TotalQueries,
    SUM(execution_count) AS TotalExecutions,
    AVG(total_elapsed_time / execution_count) / 1000 AS AvgQueryMs
FROM sys.dm_exec_query_stats;

/*
INTERPRETATION:
 - AvgQueryMs < 100  â†’ OLTP
 - 100â€“500           â†’ Mixed
 - >500              â†’ OLAP
*/


/******************************************************************************************
 FINAL SUMMARY: WHAT TO DO NEXT
******************************************************************************************
 | Metric | OLTP | Mixed | OLAP |
 |--------|------|-------|------|
 | Avg Query Duration | <100 ms | 100â€“500 ms | >500 ms |
 | Execution Count | Very high | Moderate | Low |
 | Logical Reads | Low | Moderate | High |
 | Wait Types | LCK, PAGEIOLATCH | CXPACKET + I/O mix | CXPACKET, ASYNC_NETWORK_IO |
 | Parallel Plans | Rare | Some | Frequent |

NEXT STEPS:
 - Collect results at peak workload times.
 - Observe whether your system leans toward OLTP (many small requests),
   Mixed (OLTP + reporting), or OLAP (long analytical queries).
 - Tune MAXDOP and Cost Threshold for Parallelism accordingly.
******************************************************************************************/
